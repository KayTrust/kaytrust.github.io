# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- none

stages:
- stage: Build
  pool:
    vmImage: 'ubuntu-latest'
  displayName: Build static documentation
  jobs:
  - job: BuildDoc
    displayName: Build documentation using MkDocs
    steps:
    - task: UsePythonVersion@0
      displayName: Use Python 3
      inputs:
        versionSpec: '3.x'
        addToPath: true
        architecture: 'x64'

    - script: pip install --upgrade pip
      displayName: 'Upgrade PIP'

    - script: pip install mkdocs
      displayName: 'Install mkdocs'
    - script: pip install mkdocs-material
      displayName: 'Install mkdocs Material theme'

    - script: |
        cd s
        python -m mkdocs build
      displayName: 'Build site'

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Pipeline.Workspace)/s/site'
        artifact: 'site'
        publishLocation: 'pipeline'
      displayName: 'Publish site as artifact'

- stage: Publish
  pool:
    vmImage: 'windows-latest'
  displayName: Publish to KayTrust Developer
  jobs:
  - deployment: Upload
    displayName: Upload to Azure Blob Storage
    environment: KT-DeveloperSite-Prod
    variables:
      AZURE_STORAGE_ACCOUNT: 'kaytrust'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            displayName: 'Clear Azure container'
            inputs:
              azureSubscription: 'Everis Peru SAC(f6205eb2-ffec-4f83-bad1-b1454cfd198d)'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: 'az storage blob delete-batch -s `$web --account-name $(AZURE_STORAGE_ACCOUNT) --auth-mode login'
          - task: AzureFileCopy@4
            displayName: Copy site files to container on Azure
            inputs:
              SourcePath: '$(Pipeline.Workspace)/site/*'
              azureSubscription: 'Everis Peru SAC(f6205eb2-ffec-4f83-bad1-b1454cfd198d)'
              Destination: 'AzureBlob'
              storage: '$(AZURE_STORAGE_ACCOUNT)'
              ContainerName: '$web'

- stage: Build_swagger
  pool:
    vmImage: 'ubuntu-latest'
  displayName: Build swagger documentation
  jobs:
  - job: BuildSwaggerDoc
    displayName: Build documentation using MkDocs
    steps:

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Pipeline.Workspace)/s/swagger'
        artifact: 'swagger'
        publishLocation: 'pipeline'
      displayName: 'Publish doc as artifact'

- stage: Publish_SwaggerApi
  dependsOn: Build_swagger
  pool:
    vmImage: 'windows-latest'
  displayName: Publish swagger-openapi.yaml to a blob block
  jobs:
  - deployment: Upload
    displayName: Upload to Azure Blob Storage
    environment: KT-Swagger-Docs
    variables:
      AZURE_STORAGE_ACCOUNT: 'kaytrustdemo'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            displayName: 'Clear Azure Swagger container'
            inputs:
              azureSubscription: 'Innovation & Labs(f79dbf8e-3065-4930-a70f-065b7403c892)'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: 'az storage blob delete-batch -s `$swagger --account-name $(AZURE_STORAGE_ACCOUNT) --auth-mode login'
          - task: AzureFileCopy@4
            displayName: Copy site files to container on Azure
            inputs:
              SourcePath: '$(Pipeline.Workspace)/swagger/*'
              azureSubscription: 'Innovation & Labs(f79dbf8e-3065-4930-a70f-065b7403c892)'
              Destination: 'AzureBlob'
              storage: '$(AZURE_STORAGE_ACCOUNT)'
              ContainerName: '$swagger'

